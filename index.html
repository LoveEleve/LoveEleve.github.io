<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>LoveEleve's Tech Blog</title>
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0" />
  <meta name="referrer" content="no-referrer" />

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/docsify-themeable@0/dist/css/theme-simple.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/docsify-sidebar-collapse/dist/sidebar.min.css" />

  <style>
    :root {
      --theme-color: #42b983;
      --sidebar-width: 250px;
      --content-max-width: 850px;
      --base-font-size: 13px;

      --code-border: rgba(0, 0, 0, 0.06);
      --code-toolbar-bg: #f6f8fa;
      --code-gutter-bg: #f6f8fa;
      --code-text: #24292f;
      --code-muted: #8b949e;
    }

    /* 侧边栏：首页不展示“页面内目录” */
    .sidebar-nav a[href="#/"] + ul,
    .sidebar-nav a[href="#/README"] + ul {
      display: none !important;
    }
    .sidebar-nav a[href="#/"]::after,
    .sidebar-nav a[href="#/README"]::after {
      display: none !important;
    }

    /* ---------------- 代码块：统一顶栏 + 行级折叠（直接在代码块内） ---------------- */
    pre[data-lang] {
      position: relative !important;
      margin: 1.5em 0 !important;
      padding: 3em 0 0 !important; /* 顶部留工具栏 */
      border-radius: 10px !important;
      border: 1px solid var(--code-border) !important;
      background: #fdfdfd !important;
      overflow: hidden;
    }

    pre[data-lang].is-collapsed {
      max-height: 42px !important;
      padding-bottom: 0 !important;
      cursor: pointer;
    }

    .code-tools {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 32px;
      padding: 0 12px;
      background: var(--code-toolbar-bg);
      border-bottom: 1px solid rgba(0, 0, 0, 0.05);
      display: flex;
      justify-content: space-between;
      align-items: center;
      z-index: 10;
      user-select: none;
    }

    .code-tools-left {
      font-size: 11px;
      color: var(--code-muted);
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.6px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .code-tools-left .dot {
      width: 7px;
      height: 7px;
      border-radius: 50%;
      display: inline-block;
      background: rgba(0, 0, 0, 0.12);
    }

    .code-tools-right {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .tool-btn {
      font-size: 11px;
      color: var(--theme-color);
      cursor: pointer;
      font-weight: 600;
      transition: opacity 0.15s ease;
    }

    .tool-btn:hover {
      opacity: 0.75;
    }

    /* 禁用 docsify-copy-code 的按钮（我们自己实现复制并放到顶栏） */
    .docsify-copy-code-button {
      display: none !important;
    }

    /* 行级折叠布局 */
    .fold-wrap {
      display: flex;
      background: #fff;
    }

    .fold-gutter {
      flex: 0 0 56px;
      background: var(--code-gutter-bg);
      border-right: 1px solid rgba(0, 0, 0, 0.05);
      user-select: none;
      padding: 10px 0;
    }

    .fold-gutter-row {
      height: 1.55em;
      display: flex;
      align-items: center;
      justify-content: flex-end;
      gap: 6px;
      padding: 0 10px 0 8px;
      color: #b1bac4;
      font-size: 12px;
    }

    .fold-toggle {
      width: 14px;
      height: 14px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      border-radius: 3px;
      transition: background 0.15s ease;
    }

    .fold-toggle:hover {
      background: rgba(0, 0, 0, 0.06);
    }

    .fold-toggle svg {
      width: 9px;
      height: 9px;
      fill: #6e7681;
      transition: transform 0.15s ease;
    }

    .fold-toggle.is-folded svg {
      transform: rotate(-90deg);
    }

    .fold-line-no {
      width: 28px;
      text-align: right;
      font-variant-numeric: tabular-nums;
    }

    .fold-code-scroll {
      flex: 1;
      overflow-x: auto;
      padding: 10px 0;
    }

    .fold-code-row {
      height: 1.55em;
      display: flex;
      align-items: center;
      padding: 0 12px;
      white-space: pre;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 13px;
      line-height: 1.55em;
      color: var(--code-text);
    }

    .fold-code-row.is-hidden {
      display: none;
    }

    .fold-ellipsis {
      display: none;
      margin-left: 10px;
      padding: 0 8px;
      border-radius: 999px;
      background: rgba(66, 185, 131, 0.10);
      color: var(--theme-color);
      font-size: 12px;
      cursor: pointer;
      user-select: none;
    }

    .fold-code-row.is-fold-head .fold-ellipsis {
      display: inline-block;
    }

    /* 在折叠状态，给起始行稍微高亮 */
    .fold-code-row.is-fold-head {
      background: rgba(66, 185, 131, 0.04);
    }

    /* 让 Prism token 样式还能生效（我们仍使用 Prism.highlight 输出 token span） */
    .fold-code-row .token.comment,
    .fold-code-row .token.prolog,
    .fold-code-row .token.doctype,
    .fold-code-row .token.cdata {
      color: #999;
    }

    /* 侧边栏样式 */
    .sidebar-nav > ul > li {
      margin: 10px 0;
      font-weight: bold;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <div id="app">正在加载...</div>

  <script>
    window.$docsify = {
      name: 'LoveEleve',
      repo: 'https://github.com/LoveEleve/LoveEleve.github.io',
      loadSidebar: true,
      alias: { '/.*/_sidebar.md': '/_sidebar.md' },
      subMaxLevel: 3,
      sidebarDisplayLevel: 0,
      executeScript: true,
      requestHeaders: { 'cache-control': 'max-age=0' },
      auto2top: true,

      plugins: [
        function (hook, vm) {
          function escapeHtml(str) {
            return str
              .replace(/&/g, '&amp;')
              .replace(/</g, '&lt;')
              .replace(/>/g, '&gt;')
              .replace(/"/g, '&quot;')
              .replace(/'/g, '&#39;');
          }

          function safeHighlight(line, lang) {
            try {
              if (window.Prism && Prism.languages && Prism.languages[lang]) {
                return Prism.highlight(line, Prism.languages[lang], lang);
              }
            } catch (e) {
              // ignore
            }
            return escapeHtml(line);
          }

          function buildFoldBlocks(lines) {
            // 轻量括号匹配：尽量忽略字符串/注释里的 { }
            const blocks = [];
            const stack = [];
            let inBlockComment = false;
            let inString = null; // ' or "
            let escape = false;

            function scanLine(line) {
              let openCount = 0;
              let closeCount = 0;
              for (let i = 0; i < line.length; i++) {
                const ch = line[i];
                const next = i + 1 < line.length ? line[i + 1] : '';

                if (escape) {
                  escape = false;
                  continue;
                }

                if (inString) {
                  if (ch === '\\') {
                    escape = true;
                    continue;
                  }
                  if (ch === inString) {
                    inString = null;
                  }
                  continue;
                }

                if (inBlockComment) {
                  if (ch === '*' && next === '/') {
                    inBlockComment = false;
                    i++;
                  }
                  continue;
                }

                // 行注释
                if (ch === '/' && next === '/') break;

                // 块注释
                if (ch === '/' && next === '*') {
                  inBlockComment = true;
                  i++;
                  continue;
                }

                // 字符串开始
                if (ch === '"' || ch === "'") {
                  inString = ch;
                  continue;
                }

                if (ch === '{') openCount++;
                if (ch === '}') closeCount++;
              }
              return { openCount, closeCount };
            }

            lines.forEach((line, idx) => {
              const { openCount, closeCount } = scanLine(line);

              for (let i = 0; i < openCount; i++) stack.push(idx);
              for (let i = 0; i < closeCount; i++) {
                if (stack.length === 0) continue;
                const start = stack.pop();
                const end = idx;
                // 至少折叠 2 行以上才有意义
                if (end >= start + 2) blocks.push({ start, end, folded: false });
              }
            });

            blocks.sort((a, b) => (a.start - b.start) || (b.end - a.end));
            return blocks;
          }

          function initInlineFolding(pre) {
            const langRaw = (pre.getAttribute('data-lang') || '').toLowerCase();
            const lang = langRaw === 'plain' ? 'markup' : langRaw;

            const codeEl = pre.querySelector('code');
            if (!codeEl) return;

            // 取“纯文本代码”，避免把 token span 再次解析
            const raw = (codeEl.textContent || '').replace(/\n$/, '');
            const lines = raw.split('\n');

            // 生成折叠结构
            const blocks = buildFoldBlocks(lines);
            const blocksByStart = new Map();
            blocks.forEach((b) => {
              if (!blocksByStart.has(b.start)) blocksByStart.set(b.start, []);
              blocksByStart.get(b.start).push(b);
            });

            // 清空原 code 内容，改为“同一个代码块内”的行级结构
            codeEl.innerHTML = '';

            const wrap = document.createElement('div');
            wrap.className = 'fold-wrap';

            const gutter = document.createElement('div');
            gutter.className = 'fold-gutter';

            const codeScroll = document.createElement('div');
            codeScroll.className = 'fold-code-scroll';

            wrap.appendChild(gutter);
            wrap.appendChild(codeScroll);
            codeEl.appendChild(wrap);

            const gutterRows = new Array(lines.length);
            const codeRows = new Array(lines.length);
            const ellipsisByStart = new Map();
            const toggleByStart = new Map();

            function makeChevron() {
              const span = document.createElement('span');
              span.className = 'fold-toggle';
              span.innerHTML = '<svg viewBox="0 0 16 16" aria-hidden="true"><path d="M4.5 6.5L8 10l3.5-3.5"/></svg>';
              return span;
            }

            for (let i = 0; i < lines.length; i++) {
              const gr = document.createElement('div');
              gr.className = 'fold-gutter-row';

              const startBlocks = blocksByStart.get(i);
              if (startBlocks && startBlocks.length) {
                const toggle = makeChevron();
                gr.appendChild(toggle);
                toggleByStart.set(i, toggle);
              } else {
                const spacer = document.createElement('span');
                spacer.style.width = '14px';
                spacer.style.display = 'inline-block';
                gr.appendChild(spacer);
              }

              const ln = document.createElement('span');
              ln.className = 'fold-line-no';
              ln.textContent = String(i + 1);
              gr.appendChild(ln);

              gutter.appendChild(gr);
              gutterRows[i] = gr;

              const cr = document.createElement('div');
              cr.className = 'fold-code-row';

              const html = safeHighlight(lines[i], lang);
              cr.innerHTML = html || '&nbsp;';

              const ell = document.createElement('span');
              ell.className = 'fold-ellipsis';
              ell.textContent = '…';
              cr.appendChild(ell);
              ellipsisByStart.set(i, ell);

              codeScroll.appendChild(cr);
              codeRows[i] = cr;
            }

            function recompute() {
              const hidden = new Array(lines.length).fill(false);

              // reset
              for (let i = 0; i < lines.length; i++) {
                codeRows[i].classList.remove('is-fold-head');
                const ell = ellipsisByStart.get(i);
                if (ell) {
                  ell.style.display = 'none';
                  ell.textContent = '…';
                }
              }

              blocks.forEach((b) => {
                if (!b.folded) return;
                for (let i = b.start + 1; i <= b.end; i++) hidden[i] = true;

                // start 行展示 ellipsis
                codeRows[b.start].classList.add('is-fold-head');
                const ell = ellipsisByStart.get(b.start);
                if (ell) {
                  const count = b.end - b.start;
                  ell.style.display = 'inline-block';
                  ell.textContent = `… ${count} 行`;
                }
              });

              for (let i = 0; i < lines.length; i++) {
                const isHidden = hidden[i];
                gutterRows[i].style.display = isHidden ? 'none' : 'flex';
                codeRows[i].classList.toggle('is-hidden', isHidden);
              }

              // update toggle states
              toggleByStart.forEach((toggle, start) => {
                const startBlocks = blocksByStart.get(start) || [];
                const anyFolded = startBlocks.some((b) => b.folded);
                toggle.classList.toggle('is-folded', anyFolded);
              });
            }

            // bind toggle events
            toggleByStart.forEach((toggle, start) => {
              const startBlocks = blocksByStart.get(start) || [];

              // 同一行若有多个 block（极少见），优先折叠“最长的”更符合直觉
              const pick = startBlocks.reduce((acc, cur) => {
                const accLen = acc.end - acc.start;
                const curLen = cur.end - cur.start;
                return curLen > accLen ? cur : acc;
              }, startBlocks[0]);

              toggle.onclick = (e) => {
                e.stopPropagation();
                pick.folded = !pick.folded;
                recompute();
              };

              const ell = ellipsisByStart.get(start);
              if (ell) {
                ell.onclick = (e) => {
                  e.stopPropagation();
                  pick.folded = false;
                  recompute();
                };
              }
            });

            // 初始全展开
            recompute();

            // 保留原始文本用于复制
            pre.dataset.rawCode = raw;
          }

          function initToolbar(pre) {
            if (pre.querySelector('.code-tools')) return;

            const lang = (pre.getAttribute('data-lang') || '').toUpperCase();

            const tools = document.createElement('div');
            tools.className = 'code-tools';
            tools.innerHTML = `
              <div class="code-tools-left">
                <span class="dot"></span>
                <span class="dot"></span>
                <span class="dot"></span>
                <span>${lang}</span>
              </div>
              <div class="code-tools-right">
                <span class="tool-btn btn-copy">复制</span>
                <span class="tool-btn btn-toggle">收起代码</span>
              </div>
            `;

            pre.insertBefore(tools, pre.firstChild);

            const copyBtn = tools.querySelector('.btn-copy');
            const toggleBtn = tools.querySelector('.btn-toggle');

            copyBtn.onclick = function (e) {
              e.stopPropagation();
              const text = pre.dataset.rawCode || '';
              navigator.clipboard.writeText(text).then(() => {
                copyBtn.textContent = '已复制';
                setTimeout(() => {
                  copyBtn.textContent = '复制';
                }, 1200);
              });
            };

            const handleToggle = function (e) {
              if (e) e.stopPropagation();
              const isCollapsed = pre.classList.toggle('is-collapsed');
              toggleBtn.textContent = isCollapsed ? '展开代码' : '收起代码';
            };

            toggleBtn.onclick = handleToggle;
            pre.onclick = function () {
              if (pre.classList.contains('is-collapsed')) handleToggle();
            };
          }

          hook.doneEach(function () {
            document.querySelectorAll('pre[data-lang]').forEach(function (pre) {
              // 避免重复初始化
              if (pre.dataset.inlineFoldInited === '1') return;
              pre.dataset.inlineFoldInited = '1';

              // 先初始化折叠（会保存 rawCode），再加工具栏
              initInlineFolding(pre);
              initToolbar(pre);
            });
          });
        }
      ]
    };
  </script>

  <script src="https://cdn.jsdelivr.net/npm/docsify@4/lib/docsify.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/docsify-themeable@0/dist/js/docsify-themeable.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/docsify-sidebar-collapse/dist/docsify-sidebar-collapse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/prismjs@1/components/prism-java.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/prismjs@1/components/prism-bash.min.js"></script>
</body>
</html>
